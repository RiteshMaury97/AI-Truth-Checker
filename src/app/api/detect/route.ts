\nimport { NextResponse } from \'next/server\';\nimport { GoogleGenerativeAI } from \'@google/generative-ai\';\nimport { connectToDatabase } from \'@/lib/mongodb\';\nimport ffprobe from \'ffprobe-static\';\nimport { exec } from \'child_process\';\nimport { promisify } from \'util\';\nimport exifParser from \'exif-parser\';\n\nconst execAsync = promisify(exec);\n\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \'\');\n\nasync function analyzeImage(fileUrl: string, fileBuffer: Buffer) {\n    const model = genAI.getGenerativeModel({ model: \'gemini-pro-vision\' });\n    const prompt = `Perform a deep forensic analysis of the provided image. Your analysis must include:\n1.  **Error Level Analysis (ELA):** Identify areas with different compression levels.\n2.  **Noise Consistency Check:** Look for inconsistencies in the noise pattern.\n3.  **Compression Artifacts:** Detect unusual JPEG artifacts or blocking.\n4.  **Face Anomaly Detection:** If faces are present, check for unnatural features, inconsistent lighting, or strange blending.\n\nBased on your analysis, provide a \`visualAuthenticityScore\` from 0 to 100, where 100 is completely authentic. Return a single JSON object with the score and a brief explanation.\n\nExample:\n{\n  \"visualAuthenticityScore\": 15,\n  \"explanation\": \"The image shows significant JPEG artifacts around the subject\\\'s head, and the noise pattern is inconsistent with the rest of the image. ELA reveals a high variance in compression levels.\"\n}`;\n\n    const imagePart = { inlineData: { data: Buffer.from(fileBuffer).toString(\'base64\'), mimeType: \'image/jpeg\' } };\n    const result = await model.generateContent([prompt, imagePart]);\n    const text = result.response.text();\n    const match = text.match(/{[\\s\\S]*}/);\n    if (!match) throw new Error(\"Invalid response from AI model\");\n    return JSON.parse(match[0]);\n}\n\nasync function analyzeVideo(fileUrl: string) {\n    const model = genAI.getGenerativeModel({ model: \'gemini-pro\' });\n    const prompt = `Analyze the provided video\\\'s metadata and characteristics. Your analysis must cover:\n1.  **Keyframe Analysis:** (Conceptual) Describe what you would look for in keyframes to detect manipulation.\n2.  **Temporal Consistency:** Are there any jumps, glitches, or unnatural transitions?\n3.  **Lip-Sync Consistency:** If a person is speaking, does the audio sync with their lip movements?\n\nProvide a \`videoAuthenticityScore\` from 0 to 100, where 100 is completely authentic. Return a single JSON object.\n\nExample:\n{\n  \"videoAuthenticityScore\": 25,\n  \"explanation\": \"The video shows several temporal inconsistencies, including a noticeable jump-cut at 0:15. The speaker\\\'s lip-sync is also slightly off during the second half of the video.\"\n}`;\n\n    const result = await model.generateContent(prompt);\n    const text = result.response.text();\n    const match = text.match(/{[\\s\\S]*}/);\n    if (!match) throw new Error(\"Invalid response from AI model\");\n    return JSON.parse(match[0]);\n}\n\nasync function analyzeAudio(fileUrl: string) {\n    const model = genAI.getGenerativeModel({ model: \'gemini-pro\' });\n    const prompt = `Perform a forensic analysis of this audio file. Your analysis should include:\n1.  **Spectrogram Consistency:** Are there unusual patterns or artifacts in the spectrogram?\n2.  **Voice Naturalness:** Does the voice sound natural? Check for robotic tones, flat intonation, or unnatural breathing.\n3.  **Anti-Spoofing:** (Conceptual) Describe what anti-spoofing models would look for to detect a synthesized voice.\n\nProvide an \`audioAuthenticityScore\` from 0 to 100. Return a single JSON object.\n\nExample:\n{\n  \"audioAuthenticityScore\": 30,\n  \"explanation\": \"The spectrogram shows an unnatural frequency cutoff above 15kHz, and the speaker\\\'s intonation is unusually flat throughout the recording. These are common signs of a synthesized voice.\"\n}`;\n\n    const result = await model.generateContent(prompt);\n    const text = result.response.text();\n    const match = text.match(/{[\\s\\S]*}/);\n    if (!match) throw new Error(\"Invalid response from AI model\");\n    return JSON.parse(match[0]);\n}\n\n\nasync function analyzeMetadata(fileUrl: string, fileBuffer: Buffer) {\n    let metadataOutput = \'\';\n    try {\n        if (fileUrl.match(/\\.(jpeg|jpg|tiff)$/i)) {\n            const parser = exifParser.create(fileBuffer);\n            const result = parser.parse();\n            metadataOutput = JSON.stringify(result, null, 2);\n        } else {\n            const { stdout } = await execAsync(`${ffprobe.path} -v quiet -print_format json -show_format -show_streams \"${fileUrl}\"`);\n            metadataOutput = stdout;\n        }\n    } catch (error) {\n        console.error(\'Error extracting metadata:\', error);\n        metadataOutput = \'Could not extract metadata.\';\n    }\n\n    const model = genAI.getGenerativeModel({ model: \'gemini-pro\' });\n    const prompt = `You are a digital forensics expert. Analyze the following metadata and provide a score from 0-100 for its authenticity, where 100 is completely authentic. Look for missing fields, signs of editing software, or inconsistencies. Provide the score in a JSON object: { \"metadataAuthenticityScore\": number }. Metadata: ${metadataOutput}`;\n\n    try {\n        const result = await model.generateContent(prompt);\n        const text = result.response.text();\n        const jsonMatch = text.match(/{[\\s\\S]*}/);\n        if (jsonMatch) {\n            const parsed = JSON.parse(jsonMatch[0]);\n            return { metadataAuthenticityScore: parsed.metadataAuthenticityScore || 0 };\n        }\n        return { metadataAuthenticityScore: 0 };\n    } catch (error) {\n        console.error(\"Error analyzing metadata with Gemini\", error);\n        return { metadataAuthenticityScore: 0 };\n    }\n}\n\nexport async function POST(req: Request) {\n  console.log(\'Received POST request to /api/detect\');\n  let files;\n  try {\n    const body = await req.json();\n    files = body.files;\n  } catch (error) {\n    console.error(\'Error parsing request body:\', error);\n    return NextResponse.json({ message: \'Invalid JSON in request\' }, { status: 400 });\n  }\n\n  if (!files || !Array.isArray(files)) {\n    console.log(\'Invalid request format, files not found.\');\n    return NextResponse.json({ message: \'Invalid request\' }, { status: 400 });\n  }\n\n  console.log(`Processing ${files.length} files.`);\n\n  try {\n    console.log(\'Connecting to database...\');\n    const { db } = await connectToDatabase();\n    console.log(\'Database connection successful.\');\n\n    const reportsToInsert = [];\n\n    for (const file of files) {\n        console.log(`Analyzing file: ${file.url}`);\n        let analysisResult = {};\n        const response = await fetch(file.url);\n        const fileBuffer = await response.arrayBuffer();\n\n        try {\n            const metadata = await analyzeMetadata(file.url, Buffer.from(fileBuffer));\n            analysisResult = { ...analysisResult, ...metadata };\n\n            if (file.type.startsWith(\'image\')) {\n                const imageAnalysis = await analyzeImage(file.url, Buffer.from(fileBuffer));\n                analysisResult = { ...analysisResult, ...imageAnalysis };\n            } else if (file.type.startsWith(\'video\')) {\n                const videoAnalysis = await analyzeVideo(file.url);\n                analysisResult = { ...analysisResult, ...videoAnalysis };\n            } else if (file.type.startsWith(\'audio\')) {\n                const audioAnalysis = await analyzeAudio(file.url);\n                analysisResult = { ...analysisResult, ...audioAnalysis };\n            }\n\n            const reportDocument = {\n                ...file,\n                ...analysisResult,\n                status: \'completed\',\n                createdAt: new Date(),\n            };\n            reportsToInsert.push(reportDocument);\n            console.log(`Successfully analyzed file: ${file.url}`);\n        } catch (error) {\n            console.error(`Failed to analyze file: ${file.url}`, error);\n            const failedReport = {\n                ...file,\n                status: \'failed\',\n                error: error.message,\n                createdAt: new Date(),\n            };\n            reportsToInsert.push(failedReport);\n        }\n    }\n\n    if (reportsToInsert.length > 0) {\n      console.log(\'Inserting reports into database...\');\n      await db.collection(\'analysisReports\').insertMany(reportsToInsert);\n      console.log(\'Reports inserted successfully.\');\n    }\n\n    return NextResponse.json({ reports: reportsToInsert }, { status: 201 });\n  } catch (error) {\n    console.error(\'Error processing analysis request:\', error);\n    return NextResponse.json({ message: error.message, stack: error.stack }, { status: 500 });\n  }\n}\n